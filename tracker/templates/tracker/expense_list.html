{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expense Tracker Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
    }

    .header-card, .filters-card, .total-card, .table-card, .chart-card {
      background-color: #1f1f1f;
      border-radius: .75rem;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    .header-card h2 {
      margin: 0;
      color: #fff;
    }

    .btn-theme {
      background-color: #0d6efd;
      color: #fff;
    }
    .btn-theme:hover { background-color: #0a58ca; }

    .btn-danger, .btn-warning, .btn-success { font-weight: 500; }

    .table thead { background-color: #2a2a2a; color: #fff; }
    .table tbody tr:hover { background-color: #2c2c2c; }
    .table-responsive { overflow-x: auto; }

    .badge-category {
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
      border-radius: .5rem;
      color: #fff;
    }
    .badge-FOOD { background-color: #ff6384; }
    .badge-TRAVEL { background-color: #36a2eb; }
    .badge-BILLS { background-color: #ffce56; }
    .badge-SHOPPING { background-color: #4bc0c0; }
    .badge-OTHER { background-color: #9966ff; }

    canvas {
      background-color: #1f1f1f;
      border-radius: .75rem;
      padding: 0.5rem;
    }

    @media (max-width: 768px) {
      .header-card, .filters-card, .total-card, .chart-card, .table-card {
        padding: 1rem;
      }

      .d-flex.header-buttons {
        flex-direction: column;
        gap: 0.5rem;
      }

      .chart-card { margin-bottom: 1rem; }
    }
  </style>
</head>
<body>
<div class="container mt-4">

  <!-- Header + Buttons -->
  <div class="header-card d-flex justify-content-between align-items-center flex-wrap">
    <h2>Expense Tracker Dashboard</h2>
    <div class="d-flex flex-wrap gap-2 header-buttons">
      <a href="{% url 'add_expense' %}" class="btn btn-theme">Add Expense</a>
      <a href="{% url 'export_csv' %}" class="btn btn-success">Export CSV</a>
      <a href="{% url 'export_xlsx' %}" class="btn btn-success">Export XLSX</a>
      <a href="{% url 'backup_json' %}" class="btn btn-warning">Backup</a>
      <a href="{% url 'restore_json' %}" class="btn btn-dark">Restore</a>
      <a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <form method="get" class="row g-3">
      <div class="col-12 col-md-3">
        <select name="category" class="form-select">
          <option value="">All Categories</option>
          <option value="FOOD" {% if selected_category|default:'' == "FOOD" %}selected{% endif %}>Food</option>
          <option value="TRAVEL" {% if selected_category|default:'' == "TRAVEL" %}selected{% endif %}>Travel</option>
          <option value="BILLS" {% if selected_category|default:'' == "BILLS" %}selected{% endif %}>Bills</option>
          <option value="SHOPPING" {% if selected_category|default:'' == "SHOPPING" %}selected{% endif %}>Shopping</option>
          <option value="OTHER" {% if selected_category|default:'' == "OTHER" %}selected{% endif %}>Other</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <input type="date" name="start_date" class="form-control" value="{{ start_date|default:'' }}">
      </div>
      <div class="col-6 col-md-2">
        <input type="date" name="end_date" class="form-control" value="{{ end_date|default:'' }}">
      </div>
      <div class="col-12 col-md-3">
        <input type="text" name="search" class="form-control" placeholder="Search title/notes" value="{{ search|default:'' }}">
      </div>
      <div class="col-12 col-md-2">
        <button type="submit" class="btn btn-theme w-100">Filter</button>
      </div>
    </form>
  </div>

  <!-- Total Expenses -->
  <div class="total-card text-center">
    <h4>Total Expenses: <span class="text-danger">₹{{ total|floatformat:2 }}</span></h4>
  </div>

  <!-- Charts -->
  <div class="row">
    <div class="col-12 col-md-6 chart-card mb-3">
      <canvas id="categoryChart"></canvas>
    </div>
    <div class="col-12 col-md-6 chart-card mb-3">
      <canvas id="monthlyChart"></canvas>
    </div>
  </div>

  <!-- Expenses Table -->
  <div class="table-card table-responsive">
    <table class="table table-striped table-bordered mb-0">
      <thead>
        <tr>
          <th>Title</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Date</th>
          <th>Notes</th>
          <th>Recurring</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
        <tr>
          <td>{{ expense.title }}</td>
          <td>₹{{ expense.amount|floatformat:2 }}</td>
          <td><span class="badge-category badge-{{ expense.category }}">{{ expense.category }}</span></td>
          <td>{{ expense.date }}</td>
          <td>{{ expense.notes }}</td>
          <td>{% if expense.recurring %}Yes ({{ expense.recurrence_type }}){% else %}No{% endif %}</td>
          <td>
            <a href="{% url 'edit_expense' expense.id %}" class="btn btn-sm btn-theme">Edit</a>
            <a href="{% url 'delete_expense' expense.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this expense?');">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center">No expenses found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script>
  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  new Chart(categoryCtx, {
    type: 'pie',
    data: {
      labels: {{ categories|safe }},
      datasets: [{ data: {{ category_totals|safe }}, backgroundColor: ['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff'] }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
  new Chart(monthlyCtx, {
    type: 'bar',
    data: {
      labels: {{ months|safe }},
      datasets: [{ label: 'Monthly Expenses', data: {{ monthly_totals|safe }}, backgroundColor: '#0d6efd' }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
</script>
</body>
</html>
